services:
  # CRISP - .NET 8 API + React frontend (single container)
  crisp:
    build:
      context: .
      dockerfile: src/CRISP.Api/Dockerfile
    container_name: crisp
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      # Authentication
      - Auth__Enabled=${AUTH_ENABLED:-true}
      - Auth__Jwt__Secret=${JWT_SECRET}
      - Auth__Jwt__Issuer=${JWT_ISSUER:-CRISP}
      - Auth__Jwt__Audience=${JWT_AUDIENCE:-CRISP-Web}
      - Auth__Jwt__ExpirationMinutes=${JWT_EXPIRATION:-60}
      - Auth__ApiKeys__0__Id=default
      - Auth__ApiKeys__0__Name=${API_KEY_NAME:-default}
      - Auth__ApiKeys__0__Key=${API_KEY}
      - Auth__ApiKeys__0__IsHashed=false
      - Auth__ApiKeys__0__Roles__0=User
      - Auth__ApiKeys__0__Roles__1=Admin
      # Claude API
      - Claude__ApiKey=${CLAUDE_API_KEY}
      - Claude__Model=${CLAUDE_MODEL:-claude-sonnet-4-20250514}
      # Source Control
      - Crisp__ScmPlatform=${SCM_PLATFORM:-GitHub}
      - Crisp__GitHub__Owner=${GITHUB_OWNER}
      - Crisp__GitHub__Token=${GITHUB_TOKEN}
      - Crisp__GitHub__Visibility=${GITHUB_VISIBILITY:-Private}
      - Crisp__AzureDevOps__Organization=${AZURE_DEVOPS_ORG}
      - Crisp__AzureDevOps__Project=${AZURE_DEVOPS_PROJECT}
      - Crisp__AzureDevOps__Pat=${AZURE_DEVOPS_PAT}
      - Crisp__Common__DefaultBranch=${DEFAULT_BRANCH:-main}
      - Crisp__Common__GenerateCiCd=${GENERATE_CICD:-true}
    volumes:
      - crisp-logs:/home/crisp/logs
      - crisp-workspaces:/home/crisp/workspaces
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - cloudflared-tunnel

volumes:
  crisp-logs:
    driver: local
  crisp-workspaces:
    driver: local

networks:
  cloudflared-tunnel:
    external: true
